#!/usr/bin/env bash

# config
BRANCHES=("prod" "staging")
WORK_TREE_DIR="/home/git/worktrees"

while read oldrev newrev ref; do
  branch=`echo $ref | rev | cut -d / -f 1 | rev`
  if [[ " ${BRANCHES[*]} " =~ " $branch " ]]; then
    echo "Ref $ref received. Deploying [$branch]..."

    # check out to worktree
    mkdir -p "$WORK_TREE_DIR/services"
    GIT_WORK_TREE="$WORK_TREE_DIR/services" git checkout -f $branch
    cd "$WORK_TREE_DIR/services"

    # deploy new images
    docker compose -f docker-compose.$branch.yml -p cc-$branch up -d

    # verify build status
    if [ $? -ne 0 ]; then
      echo "Build failed! Aborting."
      exit 1
    fi

    echo "Deployed [$branch] successfully!"
  else
    echo "Ref $ref received. Doing nothing: only [${BRANCHES[*]}] may be deployed on this server."
  fi
done

